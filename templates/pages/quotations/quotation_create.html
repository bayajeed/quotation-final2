{% extends 'base.html' %}

{% block title %}{% if form.instance.pk %}Edit{% else %}Create{% endif %} Quotation{% endblock %}

{% block content %}

<style>

    /* Table responsive */
    .table-responsive {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        width: 100%;
    }
    .table-responsive::-webkit-scrollbar {
            height: 16px; /* এখানে height বাড়ালে scrollbar মোটা হবে */
        }

        .table-responsive::-webkit-scrollbar-thumb {
            background: #b5b5b5;
            border-radius: 10px;
        }

        .table-responsive::-webkit-scrollbar-track {
            background: #e9e9e9;
        }

    /* input focus animation */
    input.form-control,
    select.form-select {
        transition: transform 0.15s ease, box-shadow 0.15s ease, padding 0.15s ease;
        white-space: nowrap;      /* text এক লাইনেই থাকবে */
        overflow: hidden;         /* normal অবস্থায় hidden */
    }

    input.form-control:focus,
    select.form-select:focus {
        transform: scale(1.03);
        box-shadow: 0 0 6px rgba(0, 123, 255, 0.45);
        border-color: #80bdff;
        z-index: 10;

        overflow: visible !important;   /* focus হলে text পুরোটা দেখাবে */
        position: relative;             /* overflow visible কাজ করাতে দরকার */
    }


    /* Always bigger description column */
    .desc-col {
        min-width: 280px;   /* <- এইটা নিশ্চিত করে যে description সবসময় বড় */
        width: 45%;
    }

    /* Small fields */
    .qty-col { min-width: 80px; width: 10%;}
    .unit-col { min-width: 100px; width: 15%;}
    .price-col { min-width: 120px; width: 17%; }
    .total-col { min-width: 90px; width: 13%; }

    /* Input size */
    .qty { max-width: 70px; }
    .unit { max-width: 100px; }

    /* Mobile adjustments */
    @media (max-width: 768px) {

        /* Table minimum width for scroll */
        .table {
            min-width: 750px;
        }

        .qty { max-width: 60px; }
        .unit { max-width: 80px; }
    }

</style>

    <h1>{% if form.instance.pk %}Edit{% else %}Create{% endif %} Quotation</h1>

    <form method="post" id="quotationForm">
        {% csrf_token %}
        <div class="row mb-3">
            <div class="col-md-6">
                {{ form.title.label_tag }}
                {{ form.title }}
            </div>
            <div class="col-md-6">
                {{ form.client_name.label_tag }}
                {{ form.client_name }}
            </div>
        </div>

        <div class="row mb-3">
            <div class="col-md-6">
                <label for="template" class="form-label">Load from Template</label>
                <select id="template" class="form-select">
                    <option value="">Select a template</option>
                    {% for template in templates %}
                        <option value="{{ template.pk }}">{{ template.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-6">
                <label for="id_discount" class="form-label">{{ form.discount.label }}</label>
                {{ form.discount }}
            </div>
        </div>

        <hr>

        <div id="groups-container"></div>
        <button type="button" class="btn btn-secondary" id="addGroup">Add Group</button>

        <div class="d-flex justify-content-end   mt-3">
            <div class="text-end">
                <h3>Grand Total: <span id="grand-total">0.00</span></h3>
                <h3>Less: <span id="discount-amount">0.00</span></h3>
                <hr>
                <h3>Net Payable Amount: <span id="net-payable">0.00</span></h3>
            </div>
        </div>

        <button type="submit" class="btn btn-primary mt-3">Save Quotation</button>
    </form>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const templateSelect = document.getElementById('template');
            const groupsContainer = document.getElementById('groups-container');
            const addGroupBtn = document.getElementById('addGroup');
            const grandTotalSpan = document.getElementById('grand-total');
            const discountAmountSpan = document.getElementById('discount-amount');
            const netPayableSpan = document.getElementById('net-payable');
            const discountInput = document.getElementById('id_discount');
            const quotation = {{ quotation_json|safe|default:'null' }};
            const units = [{% for unit in units %}{ id: {{ unit.pk }}, name: '{{ unit.name }}' },{% endfor %}];

            if (quotation) {
                quotation.groups.forEach(group => {
                    addGroup(group.name, group.items);
                });
                if (quotation.discount) {
                    discountInput.value = quotation.discount;
                }
                updateGrandTotal(); // Update totals on load for existing quotation
            }

            templateSelect.addEventListener('change', function() {
                const templateId = this.value;
                if (templateId) {
                    fetch(`/api/templates/${templateId}/`)
                        .then(response => response.json())
                        .then(data => {
                            groupsContainer.innerHTML = '';
                            const groups = {};
                            data.items.forEach(item => {
                                if (!groups[item.item.group.name]) {
                                    groups[item.item.group.name] = [];
                                }
                                groups[item.item.group.name].push(item);
                            });

                            for (const groupName in groups) {
                                addGroup(groupName, groups[groupName]);
                            }
                            updateGrandTotal();
                        });
                }
            });

            addGroupBtn.addEventListener('click', function() {
                addGroup();
            });

            discountInput.addEventListener('input', updateGrandTotal);

            function addGroup(name = '', items = [{}]) {
                const groupIndex = groupsContainer.children.length;
                const groupDiv = document.createElement('div');
                groupDiv.classList.add('group', 'mb-3', 'p-3', 'border');
                groupDiv.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <input type="text" name="groups-${groupIndex}-name" class="form-control" placeholder="Group Name" value="${name}">
                        <button type="button" class="btn btn-danger btn-sm remove-group">Remove Group</button>
                    </div>
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th class="desc-col">Description</th>
                                    <th class="qty-col">Qty</th>
                                    <th class="unit-col">Unit</th>
                                    <th class="price-col">Unit Price</th>
                                    <th class="total-col">Total</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody class="items-container"></tbody>
                        </table>
                    </div>
                    <div class="text-end">
                        <strong>Subtotal: <span class="subtotal">0.00</span></strong>
                    </div>
                    <button type="button" class="btn btn-success btn-sm mt-2 add-item">Add Item</button>
                `;
                groupsContainer.appendChild(groupDiv);

                const itemsContainer = groupDiv.querySelector('.items-container');
                items.forEach(item => {
                    addItem(itemsContainer, groupIndex, item);
                });

                groupDiv.querySelector('.add-item').addEventListener('click', function() {
                    addItem(itemsContainer, groupIndex);
                });

                groupDiv.querySelector('.remove-group').addEventListener('click', function() {
                    groupDiv.remove();
                    updateGrandTotal();
                });
                updateSubtotal(groupDiv);
            }

            function addItem(container, groupIndex, itemData = {}) {
                const itemIndex = container.children.length;
                const itemRow = document.createElement('tr');
                itemRow.classList.add('item');

                const item = itemData.item || {};
                const description = item.name || itemData.description || '';
                const unitPrice = itemData.unit_price !== null && itemData.unit_price !== undefined ? itemData.unit_price : (item.unit_price || 0);
                const qty = itemData.qty !== undefined ? itemData.qty : 1;

                let unitOptions = '';
                units.forEach(unit => {
                    const selected = (item.unit && item.unit.id === unit.id) || (itemData.unit && itemData.unit.id === unit.id);
                    unitOptions += `<option value="${unit.name}" ${selected ? 'selected' : ''}>${unit.name}</option>`;
                });

                itemRow.innerHTML = `
                    <input type="hidden" name="groups-${groupIndex}-items-${itemIndex}-item_id" value="${item.id || ''}">
                    <td><input type="text" name="groups-${groupIndex}-items-${itemIndex}-description" class="form-control" placeholder="Description" value="${description}"></td>
                    <td><input type="number" name="groups-${groupIndex}-items-${itemIndex}-qty" class="form-control qty" placeholder="Qty" value="${qty}"></td>
                    <td>
                        <select name="groups-${groupIndex}-items-${itemIndex}-unit" class="form-select unit">
                            ${unitOptions}
                        </select>
                    </td>
                    <td><input type="number" name="groups-${groupIndex}-items-${itemIndex}-unit_price" class="form-control unit-price" placeholder="Unit Price" value="${unitPrice}"></td>
                    <td><span class="total">0.00</span></td>
                    <td><button type="button" class="btn btn-danger btn-sm remove-item">Remove</button></td>
                `;
                container.appendChild(itemRow);

                itemRow.querySelector('.remove-item').addEventListener('click', function() {
                    itemRow.remove();
                    updateSubtotal(itemRow.closest('.group'));
                });

                itemRow.querySelectorAll('.qty, .unit-price').forEach(input => {
                    input.addEventListener('input', function() {
                        updateItemTotal(itemRow);
                    });
                });
                updateItemTotal(itemRow);
            }

            function updateItemTotal(itemRow) {
                const qty = parseFloat(itemRow.querySelector('.qty').value) || 0;
                const unitPrice = parseFloat(itemRow.querySelector('.unit-price').value) || 0;
                const total = qty * unitPrice;
                itemRow.querySelector('.total').textContent = total.toFixed(2);
                updateSubtotal(itemRow.closest('.group'));
            }

            function updateSubtotal(groupDiv) {
                let subtotal = 0;
                groupDiv.querySelectorAll('.item').forEach(itemRow => {
                    subtotal += parseFloat(itemRow.querySelector('.total').textContent) || 0;
                });
                groupDiv.querySelector('.subtotal').textContent = subtotal.toFixed(2);
                updateGrandTotal();
            }

            function updateGrandTotal() {
                let grandTotal = 0;
                groupsContainer.querySelectorAll('.group').forEach(groupDiv => {
                    grandTotal += parseFloat(groupDiv.querySelector('.subtotal').textContent) || 0;
                });
                const discount = parseFloat(discountInput.value) || 0;
                const netPayable = grandTotal - discount;

                grandTotalSpan.textContent = grandTotal.toFixed(2);
                discountAmountSpan.textContent = discount.toFixed(2);
                netPayableSpan.textContent = netPayable.toFixed(2);
            }
        });
    </script>
{% endblock %}